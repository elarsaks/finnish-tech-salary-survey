name: Deploy to Kaggle

on:
  push:
    branches: [deploy-to-kaggle]
    paths:
      - "data/*.ipynb"
      - "data/.kaggle/**"
  workflow_dispatch: # Manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      KAGGLE_API_TOKEN: ${{ secrets.KAGGLE_API_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Kaggle CLI
        run: pip install kaggle

      - name: Debug credentials
        run: |
          echo "Token length: ${#KAGGLE_API_TOKEN}"
          echo "Token first 5 chars: ${KAGGLE_API_TOKEN:0:5}"

      - name: Test Kaggle credentials
        run: kaggle kernels list --mine --page-size 1

      - name: Prepare and deploy Data Download notebook
        run: |
          mkdir -p /tmp/kaggle-download
          cp data/.kaggle/download-kernel-metadata.json /tmp/kaggle-download/kernel-metadata.json
          cp data/finnish-tech-salary-survey-2024-data-download.ipynb /tmp/kaggle-download/
          kaggle kernels push -p /tmp/kaggle-download

      - name: Prepare and deploy Data Cleaning notebook
        run: |
          mkdir -p /tmp/kaggle-cleaning
          cp data/.kaggle/cleaning-kernel-metadata.json /tmp/kaggle-cleaning/kernel-metadata.json
          cp data/finnish-tech-salary-survey-2024-data-cleaning.ipynb /tmp/kaggle-cleaning/
          kaggle kernels push -p /tmp/kaggle-cleaning

      - name: Prepare and deploy Analytics notebook
        run: |
          mkdir -p /tmp/kaggle-analytics
          cp data/.kaggle/analytics-kernel-metadata.json /tmp/kaggle-analytics/kernel-metadata.json
          cp data/finnish-tech-salary-survey-2024-analytics.ipynb /tmp/kaggle-analytics/
          kaggle kernels push -p /tmp/kaggle-analytics
